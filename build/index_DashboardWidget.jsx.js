(()=>{"use strict";const e=window.wp.components,s=window.ReactJSXRuntime,{createContext:t,useState:n,useEffect:a}=wp.element,i=t(!1);function o({children:t}){var o;const[r,c]=n(null!==(o=window.PTCCompletionist.notices)&&void 0!==o?o:[]);a((()=>()=>{window.PTCCompletionist.notices=r}),[r]);const l={notices:r,addNotice:(e,s="info",t=!0,n=[])=>{c((a=>[...a,{key:`${Date.now()}${a.length}`,children:e,status:s,isDismissible:t,actions:n}]))},removeNotice:e=>{c((s=>s.filter((s=>s!==e))))},getRenderedNotices:()=>l.notices.map((t=>{const{key:n,children:a,...i}=t;return(0,s.jsx)(e.Notice,{...i,onRemove:()=>l.removeNotice(t),children:a},n)}))};return(0,s.jsx)(i.Provider,{value:l,children:t})}function r(e){return Date.parse(e.due_on)-Date.now()<604800}function c(e){return e.filter((e=>!e.completed))}function l(e){return e.filter((e=>r(e)))}function d(e,s){return s.filter((s=>!!s.assignee&&e===s.assignee.gid))}function u(e){return e.filter((e=>!(e.action_link&&e.action_link.post_id>0)))}function p(e){return e.filter((e=>!!(e.action_link&&e.action_link.post_id>0)))}const{createContext:m,useContext:h,useEffect:k,useState:w}=wp.element,g=m(!1);function f({children:e}){var t;const{addNotice:n}=h(i),[a,o]=w(null!==(t=window.PTCCompletionist.tasks)&&void 0!==t?t:[]);k((()=>()=>{window.PTCCompletionist.tasks=a}),[a]);const r={tasks:a,setTaskProcessingStatus:(e,s)=>{o((t=>t.map((t=>t.gid==e?{...t,processingStatus:s}:{...t}))))},completeTask:async(e,s=!0)=>{const t={method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_update_task,updates:{completed:s}})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,t).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return r.updateTask({...e.data.task}),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n(`Failed to mark task as ${s?"completed":"incomplete"}.`,"error"),!1)))},deleteTask:async e=>{const s={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_delete_task})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,s).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return r.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to delete task.","error"),!1)))},unpinTask:async(e,s=null)=>{const t={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_unpin_task})};let a=`${window.PTCCompletionist.api.v1}/tasks/${e}/pins`;return s&&(a+=`/${s}`),await window.fetch(a,t).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return r.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to unpin task.","error"),!1)))},pinTask:async(e,s)=>{const t=function(e){const s=e.trim().match(/\/(\d+)\/.$/);return s&&s[1]?s[1]:""}(e);if(!t)return n("Failed to pin task. Invalid task link.","error"),!1;const a={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_pin_task,post_id:s})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${t}/pins`,a).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task)return r.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to pin task.","error"),!1)))},createTask:async(e,s=null)=>{s&&(e.post_id=s);const t={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_create_task,task:e})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks`,t).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return r.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to create task.","error"),!1)))},updateTask:e=>{o((s=>s.map((s=>s.gid==e.gid?{...s,...e}:{...s}))))},addTask:e=>{o((s=>[...s,{...e}]))},removeTask:e=>{o((s=>s.map((s=>{if(s.gid!=e)return{...s}})).filter((e=>!!e))))}};return(0,s.jsx)(g.Provider,{value:r,children:e})}const{useContext:C,useMemo:j}=wp.element;function x(){const{tasks:e}=C(g),t=j((()=>c(e)),[e]),n=e.length-t.length;let a=0;return e.length>0&&(a=Math.round(n/e.length*100)),(0,s.jsxs)("div",{className:"ptc-TaskOverview",children:[(0,s.jsxs)("div",{className:"feature",children:[(0,s.jsxs)("p",{className:"large",children:[a,(0,s.jsx)("span",{className:"small",children:"%"})]}),(0,s.jsx)("p",{className:"caption",children:"Complete"})]}),(0,s.jsxs)("div",{className:"details",children:[(0,s.jsxs)("p",{className:"incomplete",children:[(0,s.jsx)("span",{className:"count",children:t.length})," Remaining"]}),(0,s.jsxs)("div",{className:"progress",children:[(0,s.jsx)("div",{className:"progress-bar-wrapper",children:(0,s.jsx)("div",{className:"progress-bar",style:{width:`${a}%`}})}),(0,s.jsxs)("p",{className:"caption",children:[(0,s.jsxs)("span",{className:"completed",children:["Completed ",n]})," of ",e.length]})]})]})]})}const{useState:N,useCallback:T,useMemo:y,useEffect:v}=wp.element;function P({tasks:e,onChange:t}){const[n,a]=N("none"),i=y((()=>{const s=c(e);return[{key:"none",title:"All Tasks",tasks:s},{key:"pinned",title:"Pinned",tasks:p(s)},{key:"general",title:"General",tasks:u(s)},{key:"myTasks",title:"My Tasks",tasks:d(window.PTCCompletionist.me.gid,s)},{key:"critical",title:"Critical",tasks:l(s)}]}),[e]);v((()=>{const e=i.find((e=>n===e.key)).tasks;t(n,e)}),[i,n,t]);const o=T(((e,s)=>{a(e)}),[a]),r=i.map((e=>{let t=`filter-${e.key}`;return n===e.key&&(t+=" --is-active"),(0,s.jsx)("button",{type:"button",className:t,onClick:()=>o(e.key,e.tasks),children:`${e.title} (${e.tasks.length})`},e.key)}));return(0,s.jsx)("div",{className:"ptc-TaskFilters",children:r})}const b=window.wp.data,_=window.wp.editor;function $(e){let s=e(_.store).getCurrentPostId();if(!s){const e=document.getElementById("post_ID");e&&e.value&&(s=e.value)}return s}const S=window.wp.element;function D({taskGID:e,processingStatus:t}){const{deleteTask:n,unpinTask:a,removeTask:i,setTaskProcessingStatus:o}=(0,S.useContext)(g),r=(0,b.useSelect)($),c=(0,S.useCallback)((e=>{t?console.error(`Rejected handleUnpinTask. Currently ${t} task ${e}.`):(o(e,"unpinning"),a(e,r).then((s=>{s||o(e,!1)})))}),[t,o,a]),l=(0,S.useCallback)((e=>{t?console.error(`Rejected handleDeleteTask. Currently ${t} task ${e}.`):(o(e,"deleting"),n(e).then((s=>{s||o(e,!1)})))}),[t,o,i]),d=function(e){return`https://app.asana.com/0/0/${e}/f`}(e),u="unpinning"===t?"fa-sync-alt fa-spin":"fa-thumbtack",p="deleting"===t?"fa-sync-alt fa-spin":"fa-minus",m=r?"Unpin from post":"Unpin from site";return(0,s.jsxs)("div",{className:"ptc-TaskActions",children:[(0,s.jsx)("a",{href:d,target:"_asana",children:(0,s.jsx)("button",{title:"View in Asana",className:"view",type:"button",children:(0,s.jsx)("i",{className:"fas fa-link"})})}),(0,s.jsx)("button",{title:m,className:"unpin",type:"button",onClick:()=>c(e),disabled:!!t,children:(0,s.jsx)("i",{className:`fas ${u}`})}),(0,s.jsx)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>l(e),disabled:!!t,children:(0,s.jsx)("i",{className:`fas ${p}`})})]})}const{useState:E,useCallback:R,useContext:M}=wp.element;function O({task:e}){const[t,n]=E(!1),{completeTask:a,setTaskProcessingStatus:i}=M(g),o=R((s=>{e.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${e.processingStatus} task ${s}.`):(i(s,"completing"),a(s,!e.completed).then((e=>{i(s,!1)})))}),[e.processingStatus,i,a]),c=R((()=>{e.notes&&n(!t)}),[e,t,n]),l=t?"fas":"far";let d=function(e){let s=null;return e?.assignee&&(s=window.PTCCompletionist.users[e.assignee.gid]?window.PTCCompletionist.users[e.assignee.gid].data.display_name:e.assignee?.name?e.assignee.name:"(Not Connected)"),s}(e),u="";r(e)&&(u+=" --is-critical"),!0===e.completed&&(u+=" --is-complete"),e.processingStatus&&(u+=` --is-processing --is-${e.processingStatus}`),e.notes&&(u+=" --has-description");const p="completing"===e.processingStatus?"fa-sync-alt fa-spin":"fa-check",m=new Date(e.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric",timeZone:"UTC"});return(0,s.jsxs)("div",{className:"ptc-TaskRow"+u,children:[(0,s.jsx)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>o(e.gid),disabled:!!e.processingStatus,children:(0,s.jsx)("i",{className:`fas ${p}`})}),(0,s.jsxs)("div",{className:"body",children:[(0,s.jsxs)("p",{className:"name",onClick:c,children:[e.name,!!e.notes&&(0,s.jsx)("i",{className:`${l} fa-sticky-note`})]}),(0,s.jsxs)("div",{className:"details",children:[d&&(0,s.jsxs)("p",{className:"assignee",children:[(0,s.jsx)("i",{className:"fas fa-user"})," ",d]}),e.due_on&&(0,s.jsxs)("p",{className:"due",children:[(0,s.jsx)("i",{className:"fas fa-clock"})," ",m]})]}),t&&(0,s.jsx)("p",{className:"description",children:e.notes})]}),(0,s.jsxs)("div",{className:"actions",children:[(0,s.jsxs)("a",{className:"cta-button",href:e.action_link.href,target:e.action_link.target,children:[e.action_link.label," ",(0,s.jsx)("i",{className:"fas fa-long-arrow-alt-right"})]}),(0,s.jsx)(D,{taskGID:e.gid,processingStatus:e.processingStatus})]})]})}function F({tasks:e}){let t=(0,s.jsxs)("p",{className:"ptc-no-results",children:[(0,s.jsx)("i",{className:"fas fa-clipboard-check"}),"No tasks to display."]});return e.length>0&&(t=e.map((e=>(0,s.jsx)(O,{task:e},e.gid)))),(0,s.jsx)("div",{className:"ptc-TaskList",children:t})}const{useState:I,useCallback:L,useMemo:W,useEffect:A}=wp.element;function J({limit:e,tasks:t}){const[n,a]=I(1),i=W((()=>Math.ceil(t.length/e)),[t,e]),o=L((e=>{a(e<=1?1:e>=i?i:e)}),[n,a,i]);A((()=>{o(n)}),[t]);const r=Math.max(0,(n-1)*e),c=t.slice(r,n*e),l=[];for(let e=1;e<=i;++e)l.push((0,s.jsx)("button",{className:"num",type:"button",title:`Page ${e}`,disabled:e===n,onClick:()=>o(e),children:e},e));return(0,s.jsxs)("div",{className:"ptc-TaskListPaginated",children:[(0,s.jsx)(F,{tasks:c}),(0,s.jsx)("nav",{className:"pagination",children:i>1&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{className:"prev",type:"button",title:"Previous Page",disabled:1===n,onClick:()=>o(n-1),children:(0,s.jsx)("i",{className:"fas fa-angle-left"})}),l,(0,s.jsx)("button",{className:"next",type:"button",title:"Next Page",disabled:i===n,onClick:()=>o(n+1),children:(0,s.jsx)("i",{className:"fas fa-angle-right"})})]})}),(0,s.jsx)("a",{href:window.PTCCompletionist.tag_url,target:"_asana",className:"view-tag",children:(0,s.jsx)("button",{title:"View All Site Tasks in Asana",className:"view",type:"button",children:(0,s.jsx)("i",{className:"fas fa-link"})})})]})}const{useContext:X,useCallback:U,useState:B,useEffect:G}=wp.element;function V(){const{tasks:e}=X(g),[t,n]=B(c(e)),a=U(((e,s)=>n(s)),[]);return(0,s.jsxs)("div",{className:"ptc-DashboardWidget",children:[(0,s.jsx)(x,{tasks:e}),(0,s.jsx)(P,{tasks:e,onChange:a}),(0,s.jsx)(J,{limit:5,tasks:t})]})}function Z({type:e,message:t,code:n}){let a=null;"error"===e&&(a="Error",n&&(a+=` ${n}`));let i=null;a&&(i=(0,s.jsx)("strong",{children:a+". "}));let o="";return e&&(o+=` --has-type-${e}`),(0,s.jsx)("div",{className:"ptc-NoteBox"+o,children:(0,s.jsxs)("p",{children:[i,t]})})}const{useContext:q}=wp.element;function z(){const{addNotice:e,getRenderedNotices:t}=q(i);return(0,s.jsx)("div",{className:"ptc-NoticesContainer",children:t()})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("ptc-DashboardWidget");null!==e&&("error"in window.PTCCompletionist?(0,S.createRoot)(e).render((0,s.jsx)(Z,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code})):(0,S.createRoot)(e).render((0,s.jsx)(o,{children:(0,s.jsxs)(f,{children:[(0,s.jsx)(z,{}),(0,s.jsx)(V,{})]})})))}))})();