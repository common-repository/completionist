(()=>{"use strict";const e=window.wp.plugins,s=window.wp.editPost,t=window.wp.components,n=window.ReactJSXRuntime,{createContext:a,useState:i,useEffect:o}=wp.element,r=a(!1);function c({children:e}){var s;const[a,c]=i(null!==(s=window.PTCCompletionist.notices)&&void 0!==s?s:[]);o((()=>()=>{window.PTCCompletionist.notices=a}),[a]);const l={notices:a,addNotice:(e,s="info",t=!0,n=[])=>{c((a=>[...a,{key:`${Date.now()}${a.length}`,children:e,status:s,isDismissible:t,actions:n}]))},removeNotice:e=>{c((s=>s.filter((s=>s!==e))))},getRenderedNotices:()=>l.notices.map((e=>{const{key:s,children:a,...i}=e;return(0,n.jsx)(t.Notice,{...i,onRemove:()=>l.removeNotice(e),children:a},s)}))};return(0,n.jsx)(r.Provider,{value:l,children:e})}function l(){const e=[];for(const s in window.PTCCompletionist.projects)e.push((0,n.jsx)("option",{value:s,children:window.PTCCompletionist.projects[s]},s));return e}function d(){const e=[];for(const s in window.PTCCompletionist.users){const t=window.PTCCompletionist.users[s].data;e.push((0,n.jsx)("option",{value:s,children:`${t.display_name} (${t.user_email})`},s))}return e}const{createContext:p,useContext:u,useEffect:m,useState:w}=wp.element,h=p(!1);function k({children:e}){var s;const{addNotice:t}=u(r),[a,i]=w(null!==(s=window.PTCCompletionist.tasks)&&void 0!==s?s:[]);m((()=>()=>{window.PTCCompletionist.tasks=a}),[a]);const o={tasks:a,setTaskProcessingStatus:(e,s)=>{i((t=>t.map((t=>t.gid==e?{...t,processingStatus:s}:{...t}))))},completeTask:async(e,s=!0)=>{const n={method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_update_task,updates:{completed:s}})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,n).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return o.updateTask({...e.data.task}),!0;if(!e?.message)throw"unknown error";return t(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),t(`Failed to mark task as ${s?"completed":"incomplete"}.`,"error"),!1)))},deleteTask:async e=>{const s={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_delete_task})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,s).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return o.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return t(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),t("Failed to delete task.","error"),!1)))},unpinTask:async(e,s=null)=>{const n={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_unpin_task})};let a=`${window.PTCCompletionist.api.v1}/tasks/${e}/pins`;return s&&(a+=`/${s}`),await window.fetch(a,n).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return o.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return t(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),t("Failed to unpin task.","error"),!1)))},pinTask:async(e,s)=>{const n=function(e){const s=e.trim().match(/\/(\d+)\/.$/);return s&&s[1]?s[1]:""}(e);if(!n)return t("Failed to pin task. Invalid task link.","error"),!1;const a={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_pin_task,post_id:s})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${n}/pins`,a).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task)return o.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return t(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),t("Failed to pin task.","error"),!1)))},createTask:async(e,s=null)=>{s&&(e.post_id=s);const n={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_create_task,task:e})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks`,n).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return o.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return t(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),t("Failed to create task.","error"),!1)))},updateTask:e=>{i((s=>s.map((s=>s.gid==e.gid?{...s,...e}:{...s}))))},addTask:e=>{i((s=>[...s,{...e}]))},removeTask:e=>{i((s=>s.map((s=>{if(s.gid!=e)return{...s}})).filter((e=>!!e))))}};return(0,n.jsx)(h.Provider,{value:o,children:e})}const{useState:g,useContext:f}=wp.element;function C({postId:e,disabled:s=!1}){const[t,a]=g(""),[i,o]=g(!1),{pinTask:r}=f(h),c=i?"fas fa-sync-alt fa-spin":"fas fa-thumbtack";return(0,n.jsxs)("form",{className:"ptc-TaskPinToPostForm",onSubmit:s=>{s.preventDefault(),i||(o(!0),r(t,e).then((e=>{e&&a(""),o(!1)})))},disabled:i||s,children:[(0,n.jsx)("input",{type:"url",placeholder:"Paste a task link...",value:t,onChange:e=>a(e.target.value),disabled:i||s,required:!0}),(0,n.jsx)("button",{title:"Pin existing Asana task",type:"submit",disabled:i||s,children:(0,n.jsx)("i",{className:c})})]})}const{useContext:j,useState:x,useMemo:T}=wp.element;function N({postId:e=null}){const[s,t]=x(!1),[a,i]=x(""),[o,r]=x(""),[c,p]=x(""),[u,m]=x(""),[w,k]=x(""),{createTask:g}=j(h),f=T(l,[]),C=T(d,[]),N=s?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("i",{className:"fas fa-sync-alt fa-spin","aria-hidden":"true"}),"Creating task..."]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("i",{className:"fas fa-plus","aria-hidden":"true"}),"Add Task"]});return(0,n.jsxs)("form",{className:"ptc-TaskCreationForm",onSubmit:n=>{n.preventDefault(),s||(t(!0),g({name:a,assignee:o,due_on:c,project:u,notes:w},e).then((e=>{e&&(i(""),r(""),p(""),m(""),k("")),t(!1)})))},disabled:s,children:[(0,n.jsx)("input",{id:"ptc-new-task_name",type:"text",placeholder:"Write a task name...",value:a,onChange:e=>i(e.target.value),disabled:s,required:!0}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{htmlFor:"ptc-new-task_assignee",children:"Assignee"}),(0,n.jsxs)("select",{id:"ptc-new-task_assignee",value:o,onChange:e=>r(e.target.value),disabled:s,children:[(0,n.jsx)("option",{value:"",children:"None (Unassigned)"}),C]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{htmlFor:"ptc-new-task_due_on",children:"Due Date"}),(0,n.jsx)("input",{id:"ptc-new-task_due_on",type:"date",pattern:"\\d\\d\\d\\d-\\d\\d-\\d\\d",placeholder:"yyyy-mm-dd",value:c,onChange:e=>p(e.target.value),disabled:s})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{htmlFor:"ptc-new-task_project",children:"Project"}),(0,n.jsxs)("select",{id:"ptc-new-task_project",value:u,onChange:e=>m(e.target.value),disabled:s,children:[(0,n.jsx)("option",{value:"",children:"None (Private Task)"}),f]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{htmlFor:"ptc-new-task_notes",children:"Description"}),(0,n.jsx)("textarea",{id:"ptc-new-task_notes",value:w,onChange:e=>k(e.target.value),disabled:s})]}),(0,n.jsx)("button",{type:"submit",disabled:s,children:N})]})}const{useState:v}=wp.element;function P({postId:e}){const[s,t]=v(!1),a=s?"fas fa-times":"fas fa-plus";let i="";return s&&(i+=" --is-showing-creation-form"),(0,n.jsxs)("div",{className:"ptc-TaskPinToPostBar"+i,children:[(0,n.jsxs)("div",{className:"toolbar",children:[(0,n.jsx)(C,{postId:e,disabled:s}),(0,n.jsx)("button",{className:"creation-form-toggle",type:"button",title:"Create new task",onClick:()=>{t(!s)},children:(0,n.jsx)("i",{className:a,"aria-hidden":"true"})})]}),s&&(0,n.jsx)(N,{postId:e})]})}const y=window.wp.data,b=window.wp.editor;function _(e){let s=e(b.store).getCurrentPostId();if(!s){const e=document.getElementById("post_ID");e&&e.value&&(s=e.value)}return s}const S=window.wp.element;function $({taskGID:e,processingStatus:s}){const{deleteTask:t,unpinTask:a,removeTask:i,setTaskProcessingStatus:o}=(0,S.useContext)(h),r=(0,y.useSelect)(_),c=(0,S.useCallback)((e=>{s?console.error(`Rejected handleUnpinTask. Currently ${s} task ${e}.`):(o(e,"unpinning"),a(e,r).then((s=>{s||o(e,!1)})))}),[s,o,a]),l=(0,S.useCallback)((e=>{s?console.error(`Rejected handleDeleteTask. Currently ${s} task ${e}.`):(o(e,"deleting"),t(e).then((s=>{s||o(e,!1)})))}),[s,o,i]),d=function(e){return`https://app.asana.com/0/0/${e}/f`}(e),p="unpinning"===s?"fa-sync-alt fa-spin":"fa-thumbtack",u="deleting"===s?"fa-sync-alt fa-spin":"fa-minus",m=r?"Unpin from post":"Unpin from site";return(0,n.jsxs)("div",{className:"ptc-TaskActions",children:[(0,n.jsx)("a",{href:d,target:"_asana",children:(0,n.jsx)("button",{title:"View in Asana",className:"view",type:"button",children:(0,n.jsx)("i",{className:"fas fa-link"})})}),(0,n.jsx)("button",{title:m,className:"unpin",type:"button",onClick:()=>c(e),disabled:!!s,children:(0,n.jsx)("i",{className:`fas ${p}`})}),(0,n.jsx)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>l(e),disabled:!!s,children:(0,n.jsx)("i",{className:`fas ${u}`})})]})}const{useState:D,useCallback:F,useContext:I}=wp.element;function E({task:e}){const[s,t]=D(!1),{completeTask:a,setTaskProcessingStatus:i}=I(h),o=F((s=>{e.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${e.processingStatus} task ${s}.`):(i(s,"completing"),a(s,!e.completed).then((e=>{i(s,!1)})))}),[e.processingStatus,i,a]),r=F((()=>{e.notes&&t(!s)}),[e,s,t]),c=s?"fas":"far";let l=function(e){let s=null;return e?.assignee&&(s=window.PTCCompletionist.users[e.assignee.gid]?window.PTCCompletionist.users[e.assignee.gid].data.display_name:e.assignee?.name?e.assignee.name:"(Not Connected)"),s}(e),d="";(function(e){return Date.parse(e.due_on)-Date.now()<604800})(e)&&(d+=" --is-critical"),!0===e.completed&&(d+=" --is-complete"),e.processingStatus&&(d+=` --is-processing --is-${e.processingStatus}`),e.notes&&(d+=" --has-description");const p="completing"===e.processingStatus?"fa-sync-alt fa-spin":"fa-check",u=new Date(e.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric",timeZone:"UTC"});return(0,n.jsxs)("div",{className:"ptc-TaskRow"+d,children:[(0,n.jsx)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>o(e.gid),disabled:!!e.processingStatus,children:(0,n.jsx)("i",{className:`fas ${p}`})}),(0,n.jsxs)("div",{className:"body",children:[(0,n.jsxs)("p",{className:"name",onClick:r,children:[e.name,!!e.notes&&(0,n.jsx)("i",{className:`${c} fa-sticky-note`})]}),(0,n.jsxs)("div",{className:"details",children:[l&&(0,n.jsxs)("p",{className:"assignee",children:[(0,n.jsx)("i",{className:"fas fa-user"})," ",l]}),e.due_on&&(0,n.jsxs)("p",{className:"due",children:[(0,n.jsx)("i",{className:"fas fa-clock"})," ",u]})]}),s&&(0,n.jsx)("p",{className:"description",children:e.notes})]}),(0,n.jsxs)("div",{className:"actions",children:[(0,n.jsxs)("a",{className:"cta-button",href:e.action_link.href,target:e.action_link.target,children:[e.action_link.label," ",(0,n.jsx)("i",{className:"fas fa-long-arrow-alt-right"})]}),(0,n.jsx)($,{taskGID:e.gid,processingStatus:e.processingStatus})]})]})}function R({tasks:e}){let s=(0,n.jsxs)("p",{className:"ptc-no-results",children:[(0,n.jsx)("i",{className:"fas fa-clipboard-check"}),"No tasks to display."]});return e.length>0&&(s=e.map((e=>(0,n.jsx)(E,{task:e},e.gid)))),(0,n.jsx)("div",{className:"ptc-TaskList",children:s})}function O(){const{tasks:e}=(0,S.useContext)(h),s=(0,y.useSelect)(_);return(0,n.jsxs)("div",{className:"ptc-BlockEditorPanelTasks",children:[(0,n.jsx)(P,{postId:s}),(0,n.jsx)(R,{tasks:e})]})}function A({type:e,message:s,code:t}){let a=null;"error"===e&&(a="Error",t&&(a+=` ${t}`));let i=null;a&&(i=(0,n.jsx)("strong",{children:a+". "}));let o="";return e&&(o+=` --has-type-${e}`),(0,n.jsx)("div",{className:"ptc-NoteBox"+o,children:(0,n.jsxs)("p",{children:[i,s]})})}const{useContext:J}=wp.element;function M(){const{addNotice:e,getRenderedNotices:s}=J(r);return(0,n.jsx)("div",{className:"ptc-NoticesContainer",children:s()})}(0,e.registerPlugin)("ptc-completionist",{render:()=>{let e=null;return e="error"in window.PTCCompletionist?(0,n.jsx)(A,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code}):(0,n.jsx)(c,{children:(0,n.jsxs)(k,{children:[(0,n.jsx)(M,{}),(0,n.jsx)(O,{})]})}),(0,n.jsx)(s.PluginDocumentSettingPanel,{name:"ptc-completionist-tasks",title:"Completionist",className:"ptc-completionist-tasks",children:e})},icon:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 384 512",children:(0,n.jsx)("path",{d:"M336 64h-53.88C268.9 26.8 233.7 0 192 0S115.1 26.8 101.9 64H48C21.5 64 0 85.48 0 112v352C0 490.5 21.5 512 48 512h288c26.5 0 48-21.48 48-48v-352C384 85.48 362.5 64 336 64zM192 64c17.67 0 32 14.33 32 32s-14.33 32-32 32S160 113.7 160 96S174.3 64 192 64zM282.9 262.8l-88 112c-4.047 5.156-10.02 8.438-16.53 9.062C177.6 383.1 176.8 384 176 384c-5.703 0-11.25-2.031-15.62-5.781l-56-48c-10.06-8.625-11.22-23.78-2.594-33.84c8.609-10.06 23.77-11.22 33.84-2.594l36.98 31.69l72.52-92.28c8.188-10.44 23.3-12.22 33.7-4.062C289.3 237.3 291.1 252.4 282.9 262.8z"})})})})();