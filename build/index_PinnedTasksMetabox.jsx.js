(()=>{"use strict";const e=window.wp.components,t=window.ReactJSXRuntime,{createContext:s,useState:n,useEffect:a}=wp.element,o=s(!1);function i({children:s}){var i;const[r,c]=n(null!==(i=window.PTCCompletionist.notices)&&void 0!==i?i:[]);a((()=>()=>{window.PTCCompletionist.notices=r}),[r]);const l={notices:r,addNotice:(e,t="info",s=!0,n=[])=>{c((a=>[...a,{key:`${Date.now()}${a.length}`,children:e,status:t,isDismissible:s,actions:n}]))},removeNotice:e=>{c((t=>t.filter((t=>t!==e))))},getRenderedNotices:()=>l.notices.map((s=>{const{key:n,children:a,...o}=s;return(0,t.jsx)(e.Notice,{...o,onRemove:()=>l.removeNotice(s),children:a},n)}))};return(0,t.jsx)(o.Provider,{value:l,children:s})}function r(){const e=[];for(const s in window.PTCCompletionist.projects)e.push((0,t.jsx)("option",{value:s,children:window.PTCCompletionist.projects[s]},s));return e}function c(){const e=[];for(const s in window.PTCCompletionist.users){const n=window.PTCCompletionist.users[s].data;e.push((0,t.jsx)("option",{value:s,children:`${n.display_name} (${n.user_email})`},s))}return e}const{createContext:l,useContext:d,useEffect:u,useState:p}=wp.element,m=l(!1);function h({children:e}){var s;const{addNotice:n}=d(o),[a,i]=p(null!==(s=window.PTCCompletionist.tasks)&&void 0!==s?s:[]);u((()=>()=>{window.PTCCompletionist.tasks=a}),[a]);const r={tasks:a,setTaskProcessingStatus:(e,t)=>{i((s=>s.map((s=>s.gid==e?{...s,processingStatus:t}:{...s}))))},completeTask:async(e,t=!0)=>{const s={method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_update_task,updates:{completed:t}})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,s).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return r.updateTask({...e.data.task}),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n(`Failed to mark task as ${t?"completed":"incomplete"}.`,"error"),!1)))},deleteTask:async e=>{const t={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_delete_task})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${e}`,t).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return r.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to delete task.","error"),!1)))},unpinTask:async(e,t=null)=>{const s={method:"DELETE",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_unpin_task})};let a=`${window.PTCCompletionist.api.v1}/tasks/${e}/pins`;return t&&(a+=`/${t}`),await window.fetch(a,s).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task_gid)return r.removeTask(e.data.task_gid),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to unpin task.","error"),!1)))},pinTask:async(e,t)=>{const s=function(e){const t=e.trim().match(/\/(\d+)\/.$/);return t&&t[1]?t[1]:""}(e);if(!s)return n("Failed to pin task. Invalid task link.","error"),!1;const a={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_pin_task,post_id:t})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks/${s}/pins`,a).then((e=>e.json())).then((e=>{if("success"===e?.status&&e?.data?.task)return r.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to pin task.","error"),!1)))},createTask:async(e,t=null)=>{t&&(e.post_id=t);const s={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":window.PTCCompletionist.api.auth_nonce},body:window.JSON.stringify({nonce:window.PTCCompletionist.api.nonce_create_task,task:e})};return await window.fetch(`${window.PTCCompletionist.api.v1}/tasks`,s).then((e=>e.json())).then((e=>{if("success"==e?.status&&e?.data?.task)return r.addTask(e.data.task),!0;if(!e?.message)throw"unknown error";return n(e.message,"error"),!1})).catch((e=>(window.console.error("Promise catch:",e),n("Failed to create task.","error"),!1)))},updateTask:e=>{i((t=>t.map((t=>t.gid==e.gid?{...t,...e}:{...t}))))},addTask:e=>{i((t=>[...t,{...e}]))},removeTask:e=>{i((t=>t.map((t=>{if(t.gid!=e)return{...t}})).filter((e=>!!e))))}};return(0,t.jsx)(m.Provider,{value:r,children:e})}const{useState:w,useContext:k}=wp.element;function f({postId:e,disabled:s=!1}){const[n,a]=w(""),[o,i]=w(!1),{pinTask:r}=k(m),c=o?"fas fa-sync-alt fa-spin":"fas fa-thumbtack";return(0,t.jsxs)("form",{className:"ptc-TaskPinToPostForm",onSubmit:t=>{t.preventDefault(),o||(i(!0),r(n,e).then((e=>{e&&a(""),i(!1)})))},disabled:o||s,children:[(0,t.jsx)("input",{type:"url",placeholder:"Paste a task link...",value:n,onChange:e=>a(e.target.value),disabled:o||s,required:!0}),(0,t.jsx)("button",{title:"Pin existing Asana task",type:"submit",disabled:o||s,children:(0,t.jsx)("i",{className:c})})]})}const{useContext:g,useState:C,useMemo:j}=wp.element;function x({postId:e=null}){const[s,n]=C(!1),[a,o]=C(""),[i,l]=C(""),[d,u]=C(""),[p,h]=C(""),[w,k]=C(""),{createTask:f}=g(m),x=j(r,[]),T=j(c,[]),N=s?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("i",{className:"fas fa-sync-alt fa-spin","aria-hidden":"true"}),"Creating task..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("i",{className:"fas fa-plus","aria-hidden":"true"}),"Add Task"]});return(0,t.jsxs)("form",{className:"ptc-TaskCreationForm",onSubmit:t=>{t.preventDefault(),s||(n(!0),f({name:a,assignee:i,due_on:d,project:p,notes:w},e).then((e=>{e&&(o(""),l(""),u(""),h(""),k("")),n(!1)})))},disabled:s,children:[(0,t.jsx)("input",{id:"ptc-new-task_name",type:"text",placeholder:"Write a task name...",value:a,onChange:e=>o(e.target.value),disabled:s,required:!0}),(0,t.jsxs)("div",{className:"form-group",children:[(0,t.jsx)("label",{htmlFor:"ptc-new-task_assignee",children:"Assignee"}),(0,t.jsxs)("select",{id:"ptc-new-task_assignee",value:i,onChange:e=>l(e.target.value),disabled:s,children:[(0,t.jsx)("option",{value:"",children:"None (Unassigned)"}),T]})]}),(0,t.jsxs)("div",{className:"form-group",children:[(0,t.jsx)("label",{htmlFor:"ptc-new-task_due_on",children:"Due Date"}),(0,t.jsx)("input",{id:"ptc-new-task_due_on",type:"date",pattern:"\\d\\d\\d\\d-\\d\\d-\\d\\d",placeholder:"yyyy-mm-dd",value:d,onChange:e=>u(e.target.value),disabled:s})]}),(0,t.jsxs)("div",{className:"form-group",children:[(0,t.jsx)("label",{htmlFor:"ptc-new-task_project",children:"Project"}),(0,t.jsxs)("select",{id:"ptc-new-task_project",value:p,onChange:e=>h(e.target.value),disabled:s,children:[(0,t.jsx)("option",{value:"",children:"None (Private Task)"}),x]})]}),(0,t.jsxs)("div",{className:"form-group",children:[(0,t.jsx)("label",{htmlFor:"ptc-new-task_notes",children:"Description"}),(0,t.jsx)("textarea",{id:"ptc-new-task_notes",value:w,onChange:e=>k(e.target.value),disabled:s})]}),(0,t.jsx)("button",{type:"submit",disabled:s,children:N})]})}const{useState:T}=wp.element;function N({postId:e}){const[s,n]=T(!1),a=s?"fas fa-times":"fas fa-plus";let o="";return s&&(o+=" --is-showing-creation-form"),(0,t.jsxs)("div",{className:"ptc-TaskPinToPostBar"+o,children:[(0,t.jsxs)("div",{className:"toolbar",children:[(0,t.jsx)(f,{postId:e,disabled:s}),(0,t.jsx)("button",{className:"creation-form-toggle",type:"button",title:"Create new task",onClick:()=>{n(!s)},children:(0,t.jsx)("i",{className:a,"aria-hidden":"true"})})]}),s&&(0,t.jsx)(x,{postId:e})]})}const v=window.wp.data,y=window.wp.editor;function P(e){let t=e(y.store).getCurrentPostId();if(!t){const e=document.getElementById("post_ID");e&&e.value&&(t=e.value)}return t}const b=window.wp.element;function _({taskGID:e,processingStatus:s}){const{deleteTask:n,unpinTask:a,removeTask:o,setTaskProcessingStatus:i}=(0,b.useContext)(m),r=(0,v.useSelect)(P),c=(0,b.useCallback)((e=>{s?console.error(`Rejected handleUnpinTask. Currently ${s} task ${e}.`):(i(e,"unpinning"),a(e,r).then((t=>{t||i(e,!1)})))}),[s,i,a]),l=(0,b.useCallback)((e=>{s?console.error(`Rejected handleDeleteTask. Currently ${s} task ${e}.`):(i(e,"deleting"),n(e).then((t=>{t||i(e,!1)})))}),[s,i,o]),d=function(e){return`https://app.asana.com/0/0/${e}/f`}(e),u="unpinning"===s?"fa-sync-alt fa-spin":"fa-thumbtack",p="deleting"===s?"fa-sync-alt fa-spin":"fa-minus",h=r?"Unpin from post":"Unpin from site";return(0,t.jsxs)("div",{className:"ptc-TaskActions",children:[(0,t.jsx)("a",{href:d,target:"_asana",children:(0,t.jsx)("button",{title:"View in Asana",className:"view",type:"button",children:(0,t.jsx)("i",{className:"fas fa-link"})})}),(0,t.jsx)("button",{title:h,className:"unpin",type:"button",onClick:()=>c(e),disabled:!!s,children:(0,t.jsx)("i",{className:`fas ${u}`})}),(0,t.jsx)("button",{title:"Delete from Asana",className:"delete",type:"button",onClick:()=>l(e),disabled:!!s,children:(0,t.jsx)("i",{className:`fas ${p}`})})]})}const{useState:S,useCallback:$,useContext:D}=wp.element;function F({task:e}){const[s,n]=S(!1),{completeTask:a,setTaskProcessingStatus:o}=D(m),i=$((t=>{e.processingStatus?console.error(`Rejected handleMarkComplete. Currently ${e.processingStatus} task ${t}.`):(o(t,"completing"),a(t,!e.completed).then((e=>{o(t,!1)})))}),[e.processingStatus,o,a]),r=$((()=>{e.notes&&n(!s)}),[e,s,n]),c=s?"fas":"far";let l=function(e){let t=null;return e?.assignee&&(t=window.PTCCompletionist.users[e.assignee.gid]?window.PTCCompletionist.users[e.assignee.gid].data.display_name:e.assignee?.name?e.assignee.name:"(Not Connected)"),t}(e),d="";(function(e){return Date.parse(e.due_on)-Date.now()<604800})(e)&&(d+=" --is-critical"),!0===e.completed&&(d+=" --is-complete"),e.processingStatus&&(d+=` --is-processing --is-${e.processingStatus}`),e.notes&&(d+=" --has-description");const u="completing"===e.processingStatus?"fa-sync-alt fa-spin":"fa-check",p=new Date(e.due_on).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric",timeZone:"UTC"});return(0,t.jsxs)("div",{className:"ptc-TaskRow"+d,children:[(0,t.jsx)("button",{title:"Mark Complete",className:"mark-complete",type:"button",onClick:()=>i(e.gid),disabled:!!e.processingStatus,children:(0,t.jsx)("i",{className:`fas ${u}`})}),(0,t.jsxs)("div",{className:"body",children:[(0,t.jsxs)("p",{className:"name",onClick:r,children:[e.name,!!e.notes&&(0,t.jsx)("i",{className:`${c} fa-sticky-note`})]}),(0,t.jsxs)("div",{className:"details",children:[l&&(0,t.jsxs)("p",{className:"assignee",children:[(0,t.jsx)("i",{className:"fas fa-user"})," ",l]}),e.due_on&&(0,t.jsxs)("p",{className:"due",children:[(0,t.jsx)("i",{className:"fas fa-clock"})," ",p]})]}),s&&(0,t.jsx)("p",{className:"description",children:e.notes})]}),(0,t.jsxs)("div",{className:"actions",children:[(0,t.jsxs)("a",{className:"cta-button",href:e.action_link.href,target:e.action_link.target,children:[e.action_link.label," ",(0,t.jsx)("i",{className:"fas fa-long-arrow-alt-right"})]}),(0,t.jsx)(_,{taskGID:e.gid,processingStatus:e.processingStatus})]})]})}function E({tasks:e}){let s=(0,t.jsxs)("p",{className:"ptc-no-results",children:[(0,t.jsx)("i",{className:"fas fa-clipboard-check"}),"No tasks to display."]});return e.length>0&&(s=e.map((e=>(0,t.jsx)(F,{task:e},e.gid)))),(0,t.jsx)("div",{className:"ptc-TaskList",children:s})}function I(){const{tasks:e}=(0,b.useContext)(m),s=(0,v.useSelect)(P);return(0,t.jsxs)("div",{className:"ptc-BlockEditorPanelTasks",children:[(0,t.jsx)(N,{postId:s}),(0,t.jsx)(E,{tasks:e})]})}function R({type:e,message:s,code:n}){let a=null;"error"===e&&(a="Error",n&&(a+=` ${n}`));let o=null;a&&(o=(0,t.jsx)("strong",{children:a+". "}));let i="";return e&&(i+=` --has-type-${e}`),(0,t.jsx)("div",{className:"ptc-NoteBox"+i,children:(0,t.jsxs)("p",{children:[o,s]})})}const{useContext:O}=wp.element;function A(){const{addNotice:e,getRenderedNotices:s}=O(o);return(0,t.jsx)("div",{className:"ptc-NoticesContainer",children:s()})}const J=()=>{let e=null;return e="error"in window.PTCCompletionist?(0,t.jsx)(R,{type:"error",message:window.PTCCompletionist.error.message,code:window.PTCCompletionist.error.code}):(0,t.jsx)(i,{children:(0,t.jsxs)(h,{children:[(0,t.jsx)(A,{}),(0,t.jsx)(I,{})]})}),e};document.addEventListener("DOMContentLoaded",(()=>{try{const e=document.getElementById("ptc-PinnedTasksMetabox");null!==e&&(0,b.createRoot)(e).render((0,t.jsx)(J,{}))}catch(e){window.console.error(e)}}))})();